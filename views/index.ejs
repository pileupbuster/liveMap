<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <link rel="stylesheet" href="/css/style.css">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
</head>
<body>
    <div class="container">
        <div id="map" class="map-container"></div>
        
        <aside class="sidebar">
            <h1 class="sidebar-title">Recent Contacts</h1>
            <div class="operators-list">
                <% operators.forEach(function(operator) { %>
                    <div class="operator-card" data-callsign="<%= operator.callsign %>" 
                         data-lat="<%= operator.coordinates.lat %>" 
                         data-lon="<%= operator.coordinates.lon %>">
                        <img src="<%= operator.profileImage %>" alt="<%= operator.callsign %>" class="operator-image">
                        <div class="operator-info">
                            <h3 class="operator-callsign"><%= operator.callsign %></h3>
                            <p class="operator-name"><%= operator.name %></p>
                            <p class="operator-location"><%= operator.location %></p>
                            <p class="operator-grid">Grid: <%= operator.gridSquare %></p>
                        </div>
                    </div>
                <% }); %>
            </div>
        </aside>
    </div>
    
    <script>
        const operators = <%- operatorsJSON %>;
        
        const map = L.map('map').setView([39.8283, -98.5795], 4);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        const markers = {};
        
        operators.forEach(function(operator) {
            const iconHtml = `<div class="marker-icon">
                <img src="${operator.profileImage}" alt="${operator.callsign}" />
            </div>`;
            
            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'custom-marker',
                iconSize: [50, 50],
                iconAnchor: [25, 25],
                popupAnchor: [0, -25]
            });
            
            const marker = L.marker([operator.coordinates.lat, operator.coordinates.lon], {
                icon: customIcon
            }).addTo(map);
            
            const popupContent = `
                <div class="popup-content">
                    <img src="${operator.profileImage}" alt="${operator.callsign}" class="popup-image" />
                    <h3>${operator.callsign}</h3>
                    <p><strong>${operator.name}</strong></p>
                    <p>${operator.location}</p>
                    <p>Grid: ${operator.gridSquare}</p>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            markers[operator.callsign] = marker;
        });
        
        document.querySelectorAll('.operator-card').forEach(function(card) {
            card.addEventListener('click', function() {
                const callsign = this.dataset.callsign;
                const lat = parseFloat(this.dataset.lat);
                const lon = parseFloat(this.dataset.lon);
                
                map.flyTo([lat, lon], 8, {
                    duration: 1.5
                });
                
                setTimeout(function() {
                    if (markers[callsign]) {
                        markers[callsign].openPopup();
                    }
                }, 1500);
                
                document.querySelectorAll('.operator-card').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
            });
        });
    </script>
</body>
</html>